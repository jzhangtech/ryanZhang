/************************************************************************************************************************************
 *	neosmart STREAM - admin area
 *
 *	@copyright:			neosmart GmbH
 *	@licence:			https://neosmart-stream.de/legal/license-agreement/
 *	@documentation:		https://neosmart-stream.de/docs/
 *	@last update:		2015-05-22
 *	
 ************************************************************************************************************************************/
function trace(n){try{console.log(n)}catch(e){}}!function(n){n.fn.neosmartStreamAdmin=function(e){function a(){n('input[name="access_token_expires"]').length&&(n('input[name="access_token_expires"]').on("change focus keyup blur",m).trigger("keyup"),setInterval(f,1e3)),n(".nss-admin-add-channel").length&&r(),u(),n("#install-latest").length&&t()}function t(){n("#install-latest").click(i),j.updateRows=n(".nss-update-form .row"),c(0)}function i(e){e.preventDefault(),c(1),n.post("ajax-admin.php",{action:"download_latest"},function(n){"1"==n?s():c(4)})}function s(){c(2),n.post("ajax-admin.php",{action:"install_latest"},function(n){"success"==n?(c(3),window.location.reload()):c(4)})}function c(n){j.updateRows.hide().filter('[data-step="'+n+'"]').show()}function r(){n(".edit-channel").each(function(e,a){n(a).click(function(){n(".nss-admin-channel").hide(),n("#add-channel-error").hide(),n(".channel-id-"+e).fadeIn()})}),n(".nss-admin-remove").unbind("click").click(_),n(".nss-admin-remove-group").unbind("click").click(w),n(".nss-admin-add-channel").click(b),n(".save-channels").click(function(){var e=n(this).attr("data-pos");g(!1,e)}),n(".atc-button").click(function(e){var a=n(e.currentTarget);I(a.attr("data-id"))}),n(".atct-button").click(function(e){var a=n(e.currentTarget);y(a.attr("data-id"))}),n("#new-channel-type").change(v),h(),o()}function o(){n(".nss-edit-group,#nss-new-group").on("click",function(e){T.pro?(n(".nss-channel-group").hide().filter('[data-id="'+n(e.currentTarget).attr("data-id")+'"]').fadeIn(),n("#nss-new-group").hide()):n(".pro-warning").fadeIn()});n(".nss-channel-group").each(function(e,a){function t(){var e=n.trim(d.val()),a=d.find("option"),t=u.val().length?u.val().split(","):[],i="",c=!1;a.each(function(){for(var n=0;n<t.length;n++)this.value&&t[n]==this.value&&(i+=","+this.value),t[n]==e&&(c=!0)}),c===!1&&(i+=","+e),i=s(i),u.val(i)}function i(e){for(var a=n(e.currentTarget).text(),t=u.val().length?u.val().split(","):[],i="",r=0;r<t.length;r++)t[r]!=a&&(i+=","+t[r]);i=s(i),u.val(i),c()}function s(e){return e=n.trim(e),","==e.substr(0,1)&&(e=e.substr(1)),","==e.substr(e.length-1)&&(e=e.substr(0,e.length-1)),e}function c(){for(var n=u.val().length?u.val().split(","):[],e="",a=d.find("option").show(),t=0;t<n.length;t++)e+='<div class="nss-remove-group-channel">'+n[t]+"</div>",a.filter('option[value="'+n[t]+'"]').hide();a.length-1==n.length?d.hide():d.show(),f.html(e),r.find(".nss-remove-group-channel").unbind("click").on("click",i)}var r=n(a),o=r.find('[name="group_name"]'),d=r.find(".select-group-channel"),u=r.find('[name="group_channel_list"]'),f=r.find(".nss-group-table");r.find(".nss-save-groups").each(function(e,a){n(a).on("click",function(){return 0==n.trim(o.val())?(o.addClass("input-error").focus(),!1):void l()})}),d.on("change",function(){t(),c()}),c()})}function l(){var e='{"data":{';n(".nss-channel-group").each(function(a,t){var i=n(t),s=n.trim(i.find('[name="group_channel_list"]').val()),c=n.trim(i.find('[name="group_name"]').val());c=c.toLowerCase().replace(/ /gi,"").substr(0,10),c.length&&(a>0&&(e+=","),e+='\n"'+c+'":',e+='"'+s+'"')}),e+="}}",n.ajax({url:"ajax-admin.php",data:"action=save_groups&json="+e,type:"post",complete:function(n){var e=n.responseText;if("GROUPS_SAVED"==e){var a=document.location.href;a=a.substr(0,a.lastIndexOf("channels.php"))+"channels.php?saved=1",d(a)}}})}function d(e){document.location.href=e,n("body").addClass("nss-reload")}function u(){var e=n('[name="feedback_header_fb_send"]'),a=n('[name="feedback_header_fb_like"]');return e.length?(a.on("change",function(){var n=a.filter(":checked").val();"0"==n&&e.filter('[value="0"]').attr("checked",!0)}),void e.on("change",function(){var n=e.filter(":checked").val();"1"==n&&a.filter('[value="1"]').attr("checked",!0)})):!1}function f(){n('input[name="access_token_expires"]:not(.nss-unknown-time)').trigger("keyup")}function h(){n(".nss-admin-channel").each(function(e,a){var t,i,s,c,r,o=n(a),l=o.attr("data-channel"),d=1;o.find(".nss-admin-test").click(function(){switch(o.find(".channel-status").html("testing ...").addClass("loading"),l){case"facebook":t=o.find('input[name="id"]').val(),s=o.find('input[name="access_token"]').val(),d=o.find('input[name="limit"]').val(),c=o.find('select[name="show_all"]').val(),p("facebook",o,t,i,s,c,d,r);break;case"twitter":t=o.find('input[name="id"]').val(),s=o.find('input[name="access_token"]').val(),r=o.find('input[name="access_token_secret"]').val(),d=o.find('input[name="limit"]').val(),p("twitter",o,t,i,s,c,d,r);break;case"nss":i=o.find('input[name="url"]').val(),p("nss",o,t,i,s,c,d,r)}})});var e=n("#channels").attr("data-test");"auto"==e&&n(".nss-admin-test").each(function(e,a){n(a).trigger("click")})}function p(e,a,t,i,s,c,r,o){n.ajax({url:"ajax-test-channel.php",data:"channel="+e+"&id="+t+"&url="+i+"&token="+s+"&show_all="+c+"&limit="+r+"&secret="+o,type:"post",complete:function(n){var e=n.responseText;"success"==e&&(e='<span class="status active">active</span>'),a.find(".channel-status").html(e).removeClass("loading")}})}function v(){var e=n("#new-channel-type").val();switch(n(".new-channel-container").hide(),n("#add-channel-error").hide(),n('.nss-admin-channel[data-channel!="new"]').hide(),e){case"facebook":n("#nss-admin-add-channel-facebook").fadeIn();break;case"twitter":n("#nss-admin-add-channel-twitter").fadeIn();break;case"nss":n("#nss-admin-add-channel-nss").fadeIn()}}function m(e){var a=n(e.currentTarget),t=1e3*parseInt(a.val()),i=new Date,s=t-i.getTime(),c=s,r="",o=Math.floor(s/864e5);s-=864e5*o;var l=Math.floor(s/36e5);s-=36e5*l;var d=Math.floor(s/6e4);s-=6e4*d;var u=Math.floor(s/1e3);o>1?r+=o+" days ":1==o&&(r+=o+" day "),l>1?r+=l+" hours ":1==l&&(r+=l+" hour "),d>1?r+=d+" minutes ":1==d&&(r+=d+" minute "),u>1?r+=u+" seconds ":1==u&&(r+=u+" second "),0>=c&&(r="Access token is expired"),0==parseInt(a.val())&&(a.addClass("nss-unknown-time"),r='unknown - <a href="https://developers.facebook.com/tools/debug/access_token?q='+a.parent().find('[name="access_token"]').val()+'" target="_blank">Check<a/>'),a.parent().find(".expires_in_real_time").html(r)}function g(e,a){var t=[],i=e===!0?".nss-admin-channel":'.nss-admin-channel:not([data-channel="new"])';n(i).each(function(e,a){var i,s,c,r,o,l,d=n(a),u=d.attr("data-channel");switch("new"==u&&(u=n("#new-channel-type").val(),d=n("#nss-admin-add-channel-"+u)),u){case"facebook":i=n.trim(d.find('input[name="id"]').val()),s=n.trim(d.find('input[name="access_token"]').val()),c=parseInt(d.find('input[name="limit"]').val()),isNaN(c)&&(c=0),d.find('input[name="limit"]').val(c),l=d.find('[name="show_all"]').val(),o=d.find('[name="access_token_expires"]').val(),o&&s||(o=0),t.push({type:u,id:i,access_token:s,expires:o,limit:c,show:l});break;case"twitter":i=d.find('input[name="id"]').val(),s=n.trim(d.find('input[name="access_token"]').val()),access_token_secret=n.trim(d.find('input[name="access_token_secret"]').val()),c=parseInt(d.find('input[name="limit"]').val()),(isNaN(c)||1>c)&&(c=1),t.push({type:u,id:i,access_token:s,secret:access_token_secret,limit:c});break;case"nss":r=d.find('input[name="url"]').val();var f=r;"/"==f.substr(f.length-1)&&(f=f.substr(0,f.length-1)),i=f.substr(f.lastIndexOf("/")+1),i=i.replace(/[&\?\.#=]/gi,"-").substr(0,32),t.push({type:u,id:i,url:r})}}),k(t,a)}function k(e,a){n.ajax({url:"index.php",data:{action:"update_channels",channels:JSON.stringify(e)},type:"post",complete:function(){var n=document.location.href;n=n.substr(0,n.lastIndexOf("channels.php"))+"channels.php?saved=1",target=a===!1?"":"&pos="+a,d(n+target)}})}function _(e){var a=n(e.currentTarget).parent().parent();a.fadeOut(500,function(){a.remove(),g(!1)})}function w(e){var a=n(e.currentTarget).parent().parent();a.fadeOut(500,function(){a.remove(),l()})}function b(){var e,a=n("#new-channel-type").val(),t=n("#add-channel-error").hide(),i=new Date,s=(a+"_"+Math.round(99999999*Math.random())+"_"+i.getTime(),"");switch(a){case"facebook":e=n("#nss-admin-add-channel-facebook"),""==e.find('input[name="id"]').val()&&(s+="<p>Enter Your Facebook ID</p>"),""==e.find('input[name="access_token"]').val()&&(s+="<p>Enter a valid Access Token</p>");break;case"twitter":e=n("#nss-admin-add-channel-twitter"),""==e.find('input[name="id"]').val()&&(s+="<p>Enter Your Twitter ID</p>");break;case"nss":e=n("#nss-admin-add-channel-nss"),""==e.find('input[name="url"]').val()&&(s+="<p>Enter Your NSS URL</p>")}return""!=s?(t.html('<div class="row">'+s+"</div>").fadeIn(),!1):void g(!0,!1)}function x(e){e?n(".not-saved").fadeIn(500):n(".not-saved").fadeOut(500)}function I(e){var a=window.open("atc.php","ATC","width=1000,height=500,left=100,top=100"),t=n(".channel-id-"+e);a.focus();var i=setInterval(function(){try{var e=a.$.find("#atc-access-token"),s=n(e);if(s.length){var c=a.$.find("#atc-expires"),r=n(c);t.find('input[name="access_token"]').val(s.text()),t.find('input[name="access_token_expires"]').val(r.text()).trigger("change").parent().parent().fadeIn(),a.close(),clearInterval(i),x(!0)}}catch(c){}},1e3)}function y(e){var a=window.open("atct.php","ATCT","width=1000,height=500,left=100,top=100"),t=n(".channel-id-"+e);a.focus();var i=setInterval(function(){try{var e=a.$.find("#atct-token"),s=n(e);if(s.length){var c=a.$.find("#atct-secret"),r=n(c);t.find('input[name="access_token"]').val(s.text()),t.find('input[name="access_token_secret"]').val(r.text()).trigger("change").parent().parent().fadeIn(),a.close(),clearInterval(i),x(!0)}}catch(c){}},1e3)}var T=n.extend({},n.fn.neosmartStreamAdmin.defaults,e),C=this,j={};return T.pro=n("html").hasClass("pro"),a(),C},n.fn.neosmartStreamAdmin.defaults={}}(jQuery);